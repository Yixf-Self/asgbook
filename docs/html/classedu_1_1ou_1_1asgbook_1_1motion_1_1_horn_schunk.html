<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Automating Analysis of Spatial Grids: edu.ou.asgbook.motion.HornSchunk Class Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="namespaces.html"><span>Packages</span></a></li>
    <li id="current"><a href="classes.html"><span>Classes</span></a></li>
    <li><a href="files.html"><span>Files</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="classes.html"><span>Alphabetical&nbsp;List</span></a></li>
    <li><a href="annotated.html"><span>Class&nbsp;List</span></a></li>
    <li><a href="hierarchy.html"><span>Class&nbsp;Hierarchy</span></a></li>
    <li><a href="functions.html"><span>Class&nbsp;Members</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="namespaceedu.html">edu</a>.<a class="el" href="namespaceedu_1_1ou.html">ou</a>.<a class="el" href="namespaceedu_1_1ou_1_1asgbook.html">asgbook</a>.<a class="el" href="namespaceedu_1_1ou_1_1asgbook_1_1motion.html">motion</a>.<a class="el" href="classedu_1_1ou_1_1asgbook_1_1motion_1_1_horn_schunk.html">HornSchunk</a></div>
<h1>edu.ou.asgbook.motion.HornSchunk Class Reference</h1><!-- doxytag: class="edu::ou::asgbook::motion::HornSchunk" --><!-- doxytag: inherits="edu::ou::asgbook::motion::MotionEstimator" -->Horn-Schunk optical flow method of motion estimation.  
<a href="#_details">More...</a>
<p>
Inheritance diagram for edu.ou.asgbook.motion.HornSchunk:<p><center><img src="classedu_1_1ou_1_1asgbook_1_1motion_1_1_horn_schunk__inherit__graph.png" border="0" usemap="#edu_8ou_8asgbook_8motion_8_horn_schunk__inherit__map" alt="Inheritance graph"></center>
<map name="edu_8ou_8asgbook_8motion_8_horn_schunk__inherit__map">
<area href="interfaceedu_1_1ou_1_1asgbook_1_1motion_1_1_motion_estimator.html" shape="rect" coords="5,5,280,35" alt="">
</map>
<center><font size="2">[<a target="top" href="graph_legend.html">legend</a>]</font></center>Collaboration diagram for edu.ou.asgbook.motion.HornSchunk:<p><center><img src="classedu_1_1ou_1_1asgbook_1_1motion_1_1_horn_schunk__coll__graph.png" border="0" usemap="#edu_8ou_8asgbook_8motion_8_horn_schunk__coll__map" alt="Collaboration graph"></center>
<map name="edu_8ou_8asgbook_8motion_8_horn_schunk__coll__map">
<area href="interfaceedu_1_1ou_1_1asgbook_1_1motion_1_1_motion_estimator.html" shape="rect" coords="5,5,280,35" alt="">
</map>
<center><font size="2">[<a target="top" href="graph_legend.html">legend</a>]</font></center><a href="classedu_1_1ou_1_1asgbook_1_1motion_1_1_horn_schunk-members.html">List of all members.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">Override Pair&lt; <a class="el" href="classedu_1_1ou_1_1asgbook_1_1core_1_1_lat_lon_grid.html">LatLonGrid</a>,<br>
 <a class="el" href="classedu_1_1ou_1_1asgbook_1_1core_1_1_lat_lon_grid.html">LatLonGrid</a> &gt;&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classedu_1_1ou_1_1asgbook_1_1motion_1_1_horn_schunk.html#e79c6d20467a4a816eb7f9fc6df08346">compute</a> (<a class="el" href="classedu_1_1ou_1_1asgbook_1_1core_1_1_lat_lon_grid.html">LatLonGrid</a> data0, <a class="el" href="classedu_1_1ou_1_1asgbook_1_1core_1_1_lat_lon_grid.html">LatLonGrid</a> data1, File outdir)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">returns motion in the two directions.  <a href="#e79c6d20467a4a816eb7f9fc6df08346"></a><br></td></tr>
<tr><td colspan="2"><br><h2>Static Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classedu_1_1ou_1_1asgbook_1_1motion_1_1_horn_schunk.html#15f685368bf62a580f4dd44429f3fde9">main</a> (String[] args)  throws Exception </td></tr>

<tr><td colspan="2"><br><h2>Static Public Attributes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static final int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classedu_1_1ou_1_1asgbook_1_1motion_1_1_horn_schunk.html#421c0a6b8da533e6ca473e988a8a4c77">MOT_SCALE</a> = 10</td></tr>

</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
Horn-Schunk optical flow method of motion estimation. 
<p>
<dl compact><dt><b>Author:</b></dt><dd>v.lakshmanan </dd></dl>

<p>
<hr><h2>Member Function Documentation</h2>
<a class="anchor" name="e79c6d20467a4a816eb7f9fc6df08346"></a><!-- doxytag: member="edu::ou::asgbook::motion::HornSchunk::compute" ref="e79c6d20467a4a816eb7f9fc6df08346" args="(LatLonGrid data0, LatLonGrid data1, File outdir)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">Override Pair&lt;<a class="el" href="classedu_1_1ou_1_1asgbook_1_1core_1_1_lat_lon_grid.html">LatLonGrid</a>, <a class="el" href="classedu_1_1ou_1_1asgbook_1_1core_1_1_lat_lon_grid.html">LatLonGrid</a>&gt; edu.ou.asgbook.motion.HornSchunk.compute           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classedu_1_1ou_1_1asgbook_1_1core_1_1_lat_lon_grid.html">LatLonGrid</a>&nbsp;</td>
          <td class="paramname"> <em>data0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classedu_1_1ou_1_1asgbook_1_1core_1_1_lat_lon_grid.html">LatLonGrid</a>&nbsp;</td>
          <td class="paramname"> <em>data1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">File&nbsp;</td>
          <td class="paramname"> <em>outdir</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
returns motion in the two directions. 
<p>
The first one is north to south and the second one is east to west. The data is aligned to second time frame. The output dir is used for intermediate products and may be null. 
<p>
Implements <a class="el" href="interfaceedu_1_1ou_1_1asgbook_1_1motion_1_1_motion_estimator.html#40d10e32607c78de8b7cb7510d2e6b4e">edu.ou.asgbook.motion.MotionEstimator</a>.<div class="fragment"><pre class="fragment"><a name="l00032"></a>00032                                                                                                 {
<a name="l00033"></a>00033         <span class="comment">// Grids we need. initialize all of them at zero</span>
<a name="l00034"></a>00034         <span class="keyword">final</span> <span class="keywordtype">int</span> nrows = data1.getNumLat();
<a name="l00035"></a>00035         <span class="keyword">final</span> <span class="keywordtype">int</span> ncols = data1.getNumLon();
<a name="l00036"></a>00036         LatLonGrid I_x = <span class="keyword">new</span> LatLonGrid(nrows, ncols, 0, data1.getNwCorner(), data1.getLatRes(), data1.getLonRes());
<a name="l00037"></a>00037         LatLonGrid I_y = LatLonGrid.copyOf(I_x);
<a name="l00038"></a>00038         LatLonGrid I_t = LatLonGrid.copyOf(I_x);
<a name="l00039"></a>00039         LatLonGrid u = LatLonGrid.copyOf(I_x);
<a name="l00040"></a>00040         LatLonGrid v = LatLonGrid.copyOf(I_x);
<a name="l00041"></a>00041         
<a name="l00042"></a>00042         <span class="comment">// compute gradient of intensity in x, y and t directions</span>
<a name="l00043"></a>00043         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i &lt; nrows-1; ++i) <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=1; j &lt; ncols-1; ++j){
<a name="l00044"></a>00044             <span class="keywordtype">int</span> i_t = data1.getValue(i,j) - data0.getValue(i,j);   <span class="comment">// time</span>
<a name="l00045"></a>00045             <span class="keywordtype">int</span> i_x = data1.getValue(i,j) - data1.getValue(i-1,j); <span class="comment">// lat</span>
<a name="l00046"></a>00046             <span class="keywordtype">int</span> i_y = data1.getValue(i,j) - data1.getValue(i,j-1); <span class="comment">// lon</span>
<a name="l00047"></a>00047             I_x.setValue(i,j, i_x);
<a name="l00048"></a>00048             I_y.setValue(i,j, i_y);
<a name="l00049"></a>00049             I_t.setValue(i,j, i_t);
<a name="l00050"></a>00050         }
<a name="l00051"></a>00051 
<a name="l00052"></a>00052         <span class="comment">// write intermediates</span>
<a name="l00053"></a>00053         <span class="keywordflow">if</span> (outdir != null){
<a name="l00054"></a>00054             <span class="keywordflow">try</span> {
<a name="l00055"></a>00055                 KmlWriter.write(I_x, outdir, <span class="stringliteral">"I_x"</span>, PngWriter.createCoolToWarmColormap());
<a name="l00056"></a>00056                 KmlWriter.write(I_y, outdir, <span class="stringliteral">"I_y"</span>, PngWriter.createCoolToWarmColormap());
<a name="l00057"></a>00057                 KmlWriter.write(I_t, outdir, <span class="stringliteral">"I_t"</span>, PngWriter.createCoolToWarmColormap());
<a name="l00058"></a>00058             } <span class="keywordflow">catch</span> (Exception e) {
<a name="l00059"></a>00059                 e.printStackTrace();
<a name="l00060"></a>00060             }
<a name="l00061"></a>00061         }
<a name="l00062"></a>00062         
<a name="l00063"></a>00063         <span class="comment">// now iterate</span>
<a name="l00064"></a>00064         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iter=0; iter &lt; MAX_ITER; ++iter){
<a name="l00065"></a>00065             <span class="comment">// compute meanu, meanv</span>
<a name="l00066"></a>00066             LatLonGrid meanu, meanv;
<a name="l00067"></a>00067             <span class="keywordflow">if</span> ( iter == 0 ){
<a name="l00068"></a>00068                 meanu = LatLonGrid.copyOf(u);
<a name="l00069"></a>00069                 meanv = LatLonGrid.copyOf(v);
<a name="l00070"></a>00070             } <span class="keywordflow">else</span> {
<a name="l00071"></a>00071                 ConvolutionFilter boxcar = <span class="keyword">new</span> ConvolutionFilter(ConvolutionFilter.boxcar(2*SM_HALFSIZE_NS+1, 2*SM_HALFSIZE_EW+1));
<a name="l00072"></a>00072                 meanu = boxcar.smooth(u);
<a name="l00073"></a>00073                 meanv = boxcar.smooth(v);
<a name="l00074"></a>00074             }
<a name="l00075"></a>00075             
<a name="l00076"></a>00076             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i &lt; nrows-1; ++i) <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=1; j &lt; ncols-1; ++j){
<a name="l00077"></a>00077                 <span class="keywordtype">double</span> u_k = meanu.getValue(i, j)/(double)<a class="code" href="classedu_1_1ou_1_1asgbook_1_1motion_1_1_horn_schunk.html#421c0a6b8da533e6ca473e988a8a4c77">MOT_SCALE</a>;
<a name="l00078"></a>00078                 <span class="keywordtype">double</span> v_k = meanv.getValue(i, j)/(double)<a class="code" href="classedu_1_1ou_1_1asgbook_1_1motion_1_1_horn_schunk.html#421c0a6b8da533e6ca473e988a8a4c77">MOT_SCALE</a>;
<a name="l00079"></a>00079                 <span class="keywordtype">int</span> i_x = I_x.getValue(i,j);
<a name="l00080"></a>00080                 <span class="keywordtype">int</span> i_y = I_y.getValue(i,j);
<a name="l00081"></a>00081                 <span class="keywordtype">int</span> i_t = I_t.getValue(i,j);
<a name="l00082"></a>00082                 <span class="keywordtype">double</span> corr = (i_x*u_k + i_y*v_k + i_t) / (ALPHASQ + i_x*i_x + i_y*i_y);
<a name="l00083"></a>00083                 u.setValue(i,j, (<span class="keywordtype">int</span>) Math.round((u_k - i_x*corr)*<a class="code" href="classedu_1_1ou_1_1asgbook_1_1motion_1_1_horn_schunk.html#421c0a6b8da533e6ca473e988a8a4c77">MOT_SCALE</a>));
<a name="l00084"></a>00084                 v.setValue(i,j, (<span class="keywordtype">int</span>) Math.round((v_k - i_y*corr)*MOT_SCALE));
<a name="l00085"></a>00085             }
<a name="l00086"></a>00086             
<a name="l00087"></a>00087             <span class="keywordflow">if</span> (outdir != null &amp;&amp; iter == 0 || iter == 1 || iter == MAX_ITER/2){
<a name="l00088"></a>00088                 <span class="keywordflow">try</span> {
<a name="l00089"></a>00089                     KmlWriter.write(u, outdir, <span class="stringliteral">"motionNS_"</span>+iter, PngWriter.createCoolToWarmColormap());
<a name="l00090"></a>00090                     KmlWriter.write(v, outdir, <span class="stringliteral">"motionEW_"</span>+iter, PngWriter.createCoolToWarmColormap());
<a name="l00091"></a>00091                 } <span class="keywordflow">catch</span> (Exception e) {
<a name="l00092"></a>00092                     e.printStackTrace();
<a name="l00093"></a>00093                 }
<a name="l00094"></a>00094             }
<a name="l00095"></a>00095         }
<a name="l00096"></a>00096         
<a name="l00097"></a>00097         <span class="keywordflow">return</span> <span class="keyword">new</span> Pair&lt;LatLonGrid,LatLonGrid&gt;(u,v);
<a name="l00098"></a>00098     }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="15f685368bf62a580f4dd44429f3fde9"></a><!-- doxytag: member="edu::ou::asgbook::motion::HornSchunk::main" ref="15f685368bf62a580f4dd44429f3fde9" args="(String[] args)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void edu.ou.asgbook.motion.HornSchunk.main           </td>
          <td>(</td>
          <td class="paramtype">String[]&nbsp;</td>
          <td class="paramname"> <em>args</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%">  throws Exception <code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<div class="fragment"><pre class="fragment"><a name="l00100"></a>00100                                                             {
<a name="l00101"></a>00101         <span class="comment">// create output directory</span>
<a name="l00102"></a>00102         File out = OutputDirectory.getDefault(<span class="stringliteral">"hornschunk"</span>);
<a name="l00103"></a>00103         
<a name="l00104"></a>00104         <span class="comment">// read</span>
<a name="l00105"></a>00105         File f = <span class="keyword">new</span> File(<span class="stringliteral">"data/seviri"</span>);
<a name="l00106"></a>00106         Pair&lt;LatLonGrid,Date&gt;[] grids = SeviriInfraredTemperature.readAll(f);
<a name="l00107"></a>00107         
<a name="l00108"></a>00108         <span class="comment">// do alg</span>
<a name="l00109"></a>00109         MotionEstimator alg = <span class="keyword">new</span> HornSchunk();
<a name="l00110"></a>00110         Pair&lt;LatLonGrid,LatLonGrid&gt; motion = alg.compute(grids[0].first, grids[1].first, out);
<a name="l00111"></a>00111         
<a name="l00112"></a>00112         <span class="comment">// write</span>
<a name="l00113"></a>00113         KmlWriter.write(motion.first, out, <span class="stringliteral">"opticflow_u"</span>, PngWriter.createCoolToWarmColormap());
<a name="l00114"></a>00114         KmlWriter.write(motion.second, out, <span class="stringliteral">"opticflow_v"</span>, PngWriter.createCoolToWarmColormap());
<a name="l00115"></a>00115         
<a name="l00116"></a>00116         <span class="comment">// align and compute difference</span>
<a name="l00117"></a>00117         LatLonGrid diff = <span class="keyword">new</span> AlignAndDifference().compute(grids[0].first, grids[1].first, motion, <a class="code" href="classedu_1_1ou_1_1asgbook_1_1motion_1_1_horn_schunk.html#421c0a6b8da533e6ca473e988a8a4c77">MOT_SCALE</a>);
<a name="l00118"></a>00118         KmlWriter.write(diff, out, <span class="stringliteral">"opticflow_diff"</span>, PngWriter.createCoolToWarmColormap());
<a name="l00119"></a>00119     }
</pre></div>
<p>

</div>
</div><p>
<hr><h2>Member Data Documentation</h2>
<a class="anchor" name="421c0a6b8da533e6ca473e988a8a4c77"></a><!-- doxytag: member="edu::ou::asgbook::motion::HornSchunk::MOT_SCALE" ref="421c0a6b8da533e6ca473e988a8a4c77" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">final int <a class="el" href="classedu_1_1ou_1_1asgbook_1_1motion_1_1_horn_schunk.html#421c0a6b8da533e6ca473e988a8a4c77">edu.ou.asgbook.motion.HornSchunk.MOT_SCALE</a> = 10<code> [static]</code>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<hr size="1"><address style="align: right;"><small>Generated on Fri Jan 27 09:58:56 2012 for Automating Analysis of Spatial Grids by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7 </small></address>
</body>
</html>
